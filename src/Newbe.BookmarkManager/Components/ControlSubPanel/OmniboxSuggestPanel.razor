@using Newbe.BookmarkManager.Services
@using Newbe.BookmarkManager.Services.EventHubs
@using WebExtensions.Net
<Panel Header="Omnibox Suggest" Key="Omnibox Suggest" @ref="_panel">
    <ExtraTemplate>
        <Switch @bind-Value="@UserOptions.OmniboxSuggestFeature.Enabled"
                CheckedChildren="Enabled"
                UnCheckedChildren="Disabled"
                OnChange="OnEnableChange"
                />
    </ExtraTemplate>
    <ChildContent>
        @if (FeatureEnabled)
        {
            <Text>Suggest Count</Text>
            <AntDesign.InputNumber DefaultValue="Consts.OmniboxSuggestDefault" Min="Consts.OmniboxSuggestMin" Max="Consts.OmniboxSuggestMax" @bind-Value="@UserOptions.OmniboxSuggestFeature.SuggestCount" ></AntDesign.InputNumber>
        }
        else
        {
            <Paragraph>Enter the "af" keyword in the Browser's address bar,and AF can provide suggestions in response</Paragraph>
        }
    </ChildContent>
</Panel>

@code
{
    [Parameter]
    public ControlPanel.ModalModel UserOptions { get; set; } = new();
    
    private Panel _panel = null!;
    
    private bool FeatureEnabled => UserOptions?.OmniboxSuggestFeature?.Enabled == true;

    private bool FirstFeatureEnabled;
    
    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);
        _panel.Disabled = !FeatureEnabled;
        if (!FeatureEnabled)
        {
            _panel.Active = true;
        }
        if (firstRender)
        {
            FirstFeatureEnabled = UserOptions.OmniboxSuggestFeature.Enabled;
        }
    }
    
    private async Task OnEnableChange(bool oldEnabled)
    {
        UserOptions.OminiboxSuggestChanged = oldEnabled != FirstFeatureEnabled;
        if (!oldEnabled)
        {
            _panel.Disabled = false;
            _panel.Active = true;
        }
        else
        {
            _panel.Disabled = true;
            _panel.Active = false;
        }
        StateHasChanged();
    }
}
